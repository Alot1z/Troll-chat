name: ğŸ¦™ Build TrollChat iOS CLI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§¾ Configure Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ” Cache llama.cpp source
        id: cache-llama
        uses: actions/cache@v4
        with:
          path: llama
          key: llama-cpp-${{ runner.os }}-v2

      - name: ğŸ‘ Clone llama.cpp if cache miss
        if: steps.cache-llama.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 https://github.com/ggerganov/llama.cpp.git llama

      - name: âš™ï¸ Build static libllama.a via CMake
        run: |
          cd llama
          mkdir -p build
          cd build
          cmake -DLLAMA_CUBLAS=OFF -DCMAKE_BUILD_TYPE=Release ..
          make -j$(sysctl -n hw.ncpu)

      - name: ğŸ›  Build trollchat binary
        run: make

      - name: ğŸ” Codeâ€‘sign for TrollStore
        run: ldid -Sentitlements/trollchat.entitlements src/$(APP_NAME)

      - name: ğŸ“± Package .ipa
        run: |
          mkdir -p Payload/TrollChat.app
          cp src/$(APP_NAME) Payload/TrollChat.app/
          cp trollchat.plist Payload/TrollChat.app/Info.plist
          cp -r models Payload/TrollChat.app/models
          zip -qry TrollChat.ipa Payload

      - name: ğŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrollChat.ipa
          path: TrollChat.ipa
