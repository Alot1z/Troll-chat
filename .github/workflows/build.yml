name: ğŸ¦™ Build TrollChat iOS CLI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§¾ Setup Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ“¦ Install Homebrew tools
        run: |
          brew update
          brew install curl zip

      - name: ğŸ” Cache llama.cpp
        id: cache-llama
        uses: actions/cache@v4
        with:
          path: llama
          key: llama-cpp-${{ runner.os }}-v1

      - name: ğŸ‘ Download full llama.cpp (if not cached)
        if: steps.cache-llama.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 https://github.com/ggerganov/llama.cpp.git llama

      - name: âš™ï¸ Build llama.o
        run: |
          # ensure we have the SDK set up
          cd llama
          make libllama.a
          # move the library into an object
          ar -x libllama.a
          mv llama.o build/
          cd ..

      - name: ğŸ›  Build trollchat binary
        run: |
          make

      - name: ğŸ” Codeâ€‘sign for TrollStore
        run: |
          ldid -Sentitlements/trollchat.entitlements src/$(APP_NAME)

      - name: ğŸ“± Package .ipa
        run: |
          mkdir -p Payload/TrollChat.app
          cp src/$(APP_NAME) Payload/TrollChat.app/
          cp trollchat.plist Payload/TrollChat.app/Info.plist
          cp -r models Payload/TrollChat.app/models
          zip -qry TrollChat.ipa Payload

      - name: ğŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrollChat.ipa
          path: TrollChat.ipa
